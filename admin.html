<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>

<style>
body{
  font-family:Cairo;
  background:#0b1d2a;
  color:#fff;
  padding:20px
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:#132b3a
}
th,td{
  padding:10px;
  border:1px solid #1f4258;
  text-align:center
}
button{
  padding:6px 12px;
  border:none;
  background:#00e5ff;
  cursor:pointer;
  border-radius:6px;
  font-weight:bold
}
input{
  width:70px;
  padding:5px;
  text-align:center
}
</style>
</head>

<body>

<h2>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h2>

<table id="usersTable">
<tr>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
<th>Ø§Ù„ÙƒÙˆØ¯</th>
<th>Ø§Ù„Ø±ØµÙŠØ¯</th>
<th>ØªØ¹Ø¯ÙŠÙ„</th>
</tr>
</table>

<script type="module">

// ğŸ”¹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// ğŸ”¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
const firebaseConfig = {
  apiKey: "AIzaSyD5qHSNK17JFLxUj_9mnKbb7XsYVSwb9u8",
  authDomain: "btechno-b5d80.firebaseapp.com",
  projectId: "btechno-b5d80",
  storageBucket: "btechno-b5d80.appspot.com",
  messagingSenderId: "147019806629",
  appId: "1:147019806629:web:bc7828be9ae8c4b4f1da4c",
  measurementId: "G-L7DYLWVHHJ"
};

// ğŸ”¹ ØªØ´ØºÙŠÙ„ Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const table = document.getElementById("usersTable");

// ğŸ”¹ Ø­Ù…Ø§ÙŠØ© ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.location.href="login.html";
    return;
  }

 // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙŠ collection "admins"
const adminDoc = await getDoc(doc(db,"admins",user.uid));
if(!adminDoc.exists()){
  alert("ØºÙŠØ± Ù…ØµØ±Ø­ âŒ");
  window.location.href="login.html";
  return;
}

// Ù„Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§ÙƒÙ…Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
loadUsers();



  loadUsers(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯
});

// ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¨Ø§Ø´Ø± Live
function loadUsers(){
  onSnapshot(collection(db,"users"), (snapshot)=>{

    table.innerHTML = `
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
        <th>Ø§Ù„ÙƒÙˆØ¯</th>
        <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
        <th>ØªØ¹Ø¯ÙŠÙ„</th>
      </tr>
    `;

    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const uid = docSnap.id;

      table.innerHTML += `
        <tr>
          <td>${data.name || "-"}</td>
          <td>${data.email || "-"}</td>
          <td>${data.userCode || "-"}</td>
          <td id="bal-${uid}">${data.balance || 0}</td>
          <td>
            <input type="number" id="input-${uid}" placeholder="+/-">
            <button onclick="updateBalance('${uid}')">Ø­ÙØ¸</button>
          </td>
        </tr>
      `;
    });

  });
}

// ğŸ”¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯
import { arrayUnion, serverTimestamp } from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

window.updateBalance = async function(uid){

  const value = Number(document.getElementById(`input-${uid}`).value);
  if(isNaN(value) || value == 0)
    return alert("Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ");

  try{

    const userRef = doc(db,"users",uid);
    const userSnap = await getDoc(userRef);
    const currentBalance = userSnap.data().balance || 0;
    const newBalance = currentBalance + value;

    await updateDoc(userRef,{
      balance: newBalance,
      transactions: arrayUnion({
        amount: value,
        type: value > 0 ? "admin_add" : "admin_deduct",
        date: serverTimestamp(),
        by: auth.currentUser.uid
      })
    });

    document.getElementById(`bal-${uid}`).innerText = newBalance;
    alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…");

  }catch(e){
    console.error(e);
    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª âŒ");
  }
}


</script>

</body>
</html>



