<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
<style>
body{
  font-family:Cairo;
  background:#0b1d2a;
  color:#fff;
  padding:20px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:#132b3a;
}
th,td{
  padding:10px;
  border:1px solid #1f4258;
  text-align:center;
}
button{
  padding:6px 12px;
  border:none;
  background:#00e5ff;
  cursor:pointer;
  border-radius:6px;
  font-weight:bold;
}
input{
  width:70px;
  padding:5px;
  text-align:center;
}
</style>
</head>

<body>
<h2>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h2>

<table id="usersTable">
<tr>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
<th>Ø§Ù„ÙƒÙˆØ¯</th>
<th>Ø§Ù„Ø±ØµÙŠØ¯</th>
<th>ØªØ¹Ø¯ÙŠÙ„</th>
</tr>
</table>

<script type="module">
// ğŸ”¹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = {
  apiKey: "AIzaSyD5qHSNK17JFLxUj_9mnKbb7XsYVSwb9u8",
  authDomain: "btechno-b5d80.firebaseapp.com",
  projectId: "btechno-b5d80",
  storageBucket: "btechno-b5d80.appspot.com",
  messagingSenderId: "147019806629",
  appId: "1:147019806629:web:bc7828be9ae8c4b4f1da4c",
  measurementId: "G-L7DYLWVHHJ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const table = document.getElementById("usersTable");

// ğŸ”¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù†
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.location.href="login.html";
    return;
  }

  const adminDoc = await getDoc(doc(db,"admins",user.uid));
  if(!adminDoc.exists()){
    alert("ØºÙŠØ± Ù…ØµØ±Ø­ âŒ");
    window.location.href="login.html";
    return;
  }

  loadUsers();
});

// ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¨Ø§Ø´Ø± Live
function loadUsers(){
  onSnapshot(collection(db,"users"), (snapshot)=>{
    table.innerHTML = `
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
        <th>Ø§Ù„ÙƒÙˆØ¯</th>
        <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
        <th>ØªØ¹Ø¯ÙŠÙ„</th>
      </tr>
    `;
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const uid = docSnap.id;

      table.innerHTML += `
        <tr>
          <td>${data.name || "-"}</td>
          <td>${data.email || "-"}</td>
          <td>${data.userCode || "-"}</td>
          <td id="bal-${uid}">${data.balance || 0}</td>
          <td>
            <input type="number" id="input-${uid}" placeholder="+/-">
            <button onclick="updateBalance('${uid}')">Ø­ÙØ¸</button>
          </td>
        </tr>
      `;
    });
  });
}

// ğŸ”¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
window.updateBalance = async function(uid){
  const value = Number(document.getElementById(`input-${uid}`).value);
  if(isNaN(value) || value === 0){
    return alert("Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ");
  }

  try {
    const userRef = doc(db, "users", uid);
    const userSnap = await getDoc(userRef);
    const currentBalance = userSnap.data().balance || 0;
    const newBalance = currentBalance + value;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ transactions
    await updateDoc(userRef, {
      balance: newBalance,
      transactions: arrayUnion({
        amount: value,
        type: value > 0 ? "admin_add" : "admin_deduct",
        date: new Date().toISOString(),
        by: auth.currentUser.uid
      })
    });

    document.getElementById(`bal-${uid}`).innerText = newBalance;
    alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…");

  } catch (e) {
    console.error(e);
    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª âŒ");
  }
}
</script>

</body>
</html>
