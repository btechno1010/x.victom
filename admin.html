<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>

<style>
body{
  font-family:"Cairo",sans-serif;
  background:#f0f0f0;
  padding:30px;
  direction:rtl;
}
h2{color:#0072ff;}
input,button{
  padding:10px;
  margin:5px;
  border-radius:10px;
  border:1px solid #ccc;
}
button{
  border:none;
  background:#0072ff;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
button:hover{background:#005bb5;}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  border:1px solid #ccc;
  padding:10px;
  text-align:center;
}
th{
  background:#0072ff;
  color:#fff;
}
</style>
</head>
<body>

<h2>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - ØªØ¹Ø¯ÙŠÙ„ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>

<div>
<input type="email" id="userEmail" placeholder="Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
<button onclick="addBalance()">â• Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯</button>
<button onclick="removeBalance()">â– Ø®ØµÙ… Ø±ØµÙŠØ¯</button>
<button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
<p id="msg" style="color:red;font-size:14px;"></p>
</div>

<h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
<table id="usersTable">
<tr><th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th></tr>
</table>

<!-- Firebase -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  signOut 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import { 
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


const firebaseConfig = {
  apiKey: "AIzaSyD5qHSNK17JFLxUj_9mnKbb7XsYVSwb9u8",
  authDomain: "btechno-b5d80.firebaseapp.com",
  projectId: "btechno-b5d80",
  storageBucket: "btechno-b5d80.appspot.com",
  messagingSenderId: "147019806629",
  appId: "1:147019806629:web:bc7828be9ae8c4b4f1da4c",
  measurementId: "G-L7DYLWVHHJ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const table = document.getElementById("usersTable");
const msg = document.getElementById("msg");

// ğŸ” Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø£Ø¯Ù…Ù†
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "admin.html";
    return;
  }

  const q = query(collection(db, "users"), where("email", "==", user.email));
  const snapshot = await getDocs(q);

  if (snapshot.empty || snapshot.docs[0].data().role !== "admin") {
    alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„");
    window.location.href = "admin.html";
  } else {
    loadUsers();
  }
});

// ğŸ“‹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function loadUsers() {
  table.innerHTML = "<tr><th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th></tr>";
  const querySnapshot = await getDocs(collection(db, "users"));
  querySnapshot.forEach((docSnap) => {
    const data = docSnap.data();
    table.innerHTML += `
      <tr>
        <td>${data.email}</td>
        <td>${data.name}</td>
        <td>${data.balance || 0}</td>
      </tr>
    `;
  });
}

// â• Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯
window.addBalance = async function() {
  const email = document.getElementById("userEmail").value.trim();
  const amount = Number(document.getElementById("amount").value);

  if (!email || amount <= 0) {
    msg.innerText = "âŒ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©";
    return;
  }

  const q = query(collection(db, "users"), where("email", "==", email));
  const snapshot = await getDocs(q);

  if (snapshot.empty) {
    msg.innerText = "âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    return;
  }

  const userDoc = snapshot.docs[0];
  const newBalance = (userDoc.data().balance || 0) + amount;

  await updateDoc(doc(db, "users", userDoc.id), {
    balance: newBalance
  });

  msg.style.color = "green";
  msg.innerText = "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯";

  loadUsers();
};

// â– Ø®ØµÙ… Ø±ØµÙŠØ¯
window.removeBalance = async function() {
  const email = document.getElementById("userEmail").value.trim();
  const amount = Number(document.getElementById("amount").value);

  if (!email || amount <= 0) {
    msg.innerText = "âŒ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©";
    return;
  }

  const q = query(collection(db, "users"), where("email", "==", email));
  const snapshot = await getDocs(q);

  if (snapshot.empty) {
    msg.innerText = "âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    return;
  }

  const userDoc = snapshot.docs[0];
  const currentBalance = userDoc.data().balance || 0;

  if (currentBalance < amount) {
    msg.innerText = "âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ";
    return;
  }

  await updateDoc(doc(db, "users", userDoc.id), {
    balance: currentBalance - amount
  });

  msg.style.color = "green";
  msg.innerText = "âœ… ØªÙ… Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯";

  loadUsers();
};

// ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
window.logout = async function() {
  await signOut(auth);
  window.location.href = "admin.html";
};

</script>

</body>
</html>
